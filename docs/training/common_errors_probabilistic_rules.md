# Common Errors and Solutions for Probabilistic Rules

> **⚠️ DEPRECATED:** This file has been reorganized into separate guides:
> - **`genai_logic_patterns.md`** - Framework-level patterns (universal)
> - **`probabilistic_logic_guide.md`** - Probabilistic logic implementation patterns
> - **`pdl_project_guide.md`** - PDL project-specific workflows and troubleshooting
>
> This file remains for backward compatibility but may be removed in future.

---

## Critical Import Error

### ❌ WRONG:
```python
from logic_bank.rule_bank.rule_bank import RuleBank
from logic_bank.extensions.rule_extensions import Rule

RuleBank.formula(...)
RuleBank.early_row_event(...)
```

### ✅ CORRECT:
```python
from logic_bank.logic_bank import Rule

Rule.formula(...)
Rule.early_row_event(...)
```

**Why:** `RuleBank` is the internal class, not the public API. The public API is `Rule` from `logic_bank.logic_bank`.

---

## "Session is Already Flushing" Error

### ❌ WRONG Pattern (causes nested flush):
```python
def get_supplier_price_from_ai(row, logic_row, ...):
    # Trying to create audit record using session API
    supplier_req = models.SysSupplierReq(
        product_id=row.product_id,
        item_id=row.id
    )
    logic_row.session.add(supplier_req)
    logic_row.session.flush()  # ❌ ERROR: Session is already flushing
    return supplier_req.chosen_unit_price
```

**Why this fails:** Formulas execute DURING SQLAlchemy's flush cycle. You cannot flush while already flushing (nested flush not allowed).

### ✅ CORRECT Pattern (LogicBank triggered insert):
```python
def get_supplier_price_from_ai(row, logic_row, ...):
    # Use LogicBank's triggered insert API
    sys_supplier_req_logic_row = logic_row.new_logic_row(models.SysSupplierReq)
    sys_supplier_req = sys_supplier_req_logic_row.row
    sys_supplier_req_logic_row.link(to_parent=logic_row)
    sys_supplier_req.product_id = row.product_id
    sys_supplier_req.item_id = row.id
    sys_supplier_req_logic_row.insert(reason="Supplier AI Request")
    return sys_supplier_req.chosen_unit_price  # Populated by event handler

def supplier_id_from_ai(row, old_row, logic_row):
    if logic_row.is_inserted():
        # Populate audit fields
        row.chosen_supplier_id = ...
        row.chosen_unit_price = ...
        row.reason = ...

Rule.early_row_event(on_class=models.SysSupplierReq, calling=supplier_id_from_ai)
```

**Why this works:** LogicBank's `logic_row.insert()` uses LogicBank's insert mechanism, not session.flush(). The event handler fires DURING formula execution, populating fields before the formula returns the value.

Reference: https://apilogicserver.github.io/Docs/Logic-Use/#in-logic

---

## Alembic Autogenerate Chaos

### Problem:
When running `alembic revision --autogenerate`, it generates 40+ lines of unwanted ALTER TABLE statements, not just the new table you want to add.

### Root Cause:
Alembic detects ALL differences between models.py and database schema, including:
- Old migrations never applied
- Schema drift from previous changes
- Nullable/NOT NULL differences
- Missing columns from old models

### ✅ Solution:
1. Generate migration: `alembic revision --autogenerate -m "add_table"`
2. **Manually edit the migration file:**
   - Remove ALL ALTER TABLE statements
   - Keep ONLY the CREATE TABLE for your new table
   - Simplify downgrade() to only DROP TABLE
3. Apply: `alembic upgrade head`

**Example of manual editing:**
```python
# Before (autogenerated):
def upgrade():
    op.create_table('sys_supplier_req', ...)
    op.alter_column('customer', 'id', ...)  # ❌ Remove this
    op.drop_column('order', 'CreatedOn')     # ❌ Remove this
    # ... 30+ more unwanted changes

# After (manual edit):
def upgrade():
    # Manually edited to remove unwanted changes
    op.create_table('sys_supplier_req', ...)
    # That's it!
```

**Documentation:** This is already noted in training docs: "Alembic autogenerate requires manual editing"

---

## restart.sh Workflow Confusion

### Understanding restart.sh:
`restart.sh` is designed to **reset the project to a "clean database" state** before adding logic. It:

1. **Kills server** - Stops any running instance
2. **Resets database** - Loads from basic_demo.sql
3. **Overwrites files:**
   - `database/models.py` ← `database/models_restart.py`
   - `ui/admin/admin.yaml` ← `ui/admin/admin_restart.yaml`
4. **Deletes generated logic:**
   - `logic/logic_discovery/check_credit.py`
   - `logic/logic_discovery/ai_requests/`

### Purpose:
Simulates starting from an existing database, then introducing deterministic + probabilistic logic.

### ⚠️ After running restart.sh, you MUST:
1. Regenerate logic files (check_credit.py, supplier_selection.py)
2. Add SysSupplierReq model to database/models.py
3. Run alembic migration (manually edit!)
4. Update ui/admin/admin.yaml with SysSupplierReq resource
5. Start server and test

### Common Mistake:
Forgetting that restart.sh **deletes all logic files** and **overwrites admin.yaml**. If you added SysSupplierReq to admin.yaml before restart.sh, it's gone after.

---

## Missing Admin App Table

### Symptom:
SysSupplierReq table doesn't appear in Admin App UI, even though API works (`curl http://localhost:5656/api/SysSupplierReq` returns data).

### Root Cause:
`restart.sh` overwrites `ui/admin/admin.yaml` from `ui/admin/admin_restart.yaml`, which doesn't include SysSupplierReq.

### ✅ Solution:
After restart.sh and migration, manually update `ui/admin/admin.yaml`:

```yaml
info:
  number_relationships: 10
  number_tables: 8  # Updated from 7

resources:
  # ... existing resources ...
  
  SysSupplierReq:
    attributes:
    - name: id
    - name: item_id
    - name: product_id
    - name: chosen_supplier_id
    - name: chosen_unit_price
      type: DECIMAL
    - name: request
    - name: reason
    - name: created_on
      type: DateTime
    description: Audit table for AI supplier selection requests and results
    tab_groups:
    - direction: toone
      fks:
      - item_id
      label: Item
      name: ItemList
      resource: Item
    # ... etc
```

---

## Logic Files Not Loaded

### Symptom:
Server starts but rules don't fire. Logic log shows "0 rules loaded" or rules don't execute.

### Root Cause:
Logic files don't exist in `logic/logic_discovery/` (deleted by restart.sh or never created).

### ✅ Solution:
Check if files exist:
```bash
ls -la logic/logic_discovery/
# Should show: check_credit.py, ai_requests/supplier_selection.py
```

If missing, regenerate:
```bash
python alp_verify_only.py  # Or manually create files
```

---

## Summary Checklist

After restart.sh, complete workflow:

- [ ] Kill server: `lsof -ti:5656 | xargs kill -9`
- [ ] Run restart.sh: `sh restart.sh x`
- [ ] Generate logic files (check_credit.py, supplier_selection.py)
- [ ] Add SysSupplierReq to database/models.py with relationships
- [ ] Run alembic: `alembic revision --autogenerate -m "..."`
- [ ] Manually edit migration (remove unwanted ALTER statements)
- [ ] Apply migration: `alembic upgrade head`
- [ ] Update ui/admin/admin.yaml with SysSupplierReq resource
- [ ] Start server: `python api_logic_server_run.py`
- [ ] Test: `curl -X POST http://localhost:5656/api/Item ...`
- [ ] Verify audit: `curl http://localhost:5656/api/SysSupplierReq`
